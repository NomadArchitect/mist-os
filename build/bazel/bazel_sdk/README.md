# How the platform build manages IDKs and SDKs

This document describes how the Fuchsia IDKs and Bazel SDKs
are generated by the platform build, the role of each instance
and their relationships. This information is crucial for the
rest of the migration to Bazel, and will be updated accordingly.

## The GN-generated IDKs and Bazel SDKs

### The Fuchsia Core IDK

The GN `//sdk:final_fuchsia_idk` target is used to build and
validate the Fuchsia Core IDK, which is the official archive
distributed to third-party developers, and which all atoms in
the "partner" category, as well as prebuilt binaries for all
supported CPU architectures, and supported API levels.

Currently, this is built directly from Ninja (no Bazel required)
as the shape of the Core IDK (i.e. which atoms it includes) it
entirely defined in the GN build graph.

Note that building the core IDK is very long, due to the high number
of `(cpu, api_level)` combinations it needs to support. Thus is only
built by a few dedicated builder configurations (e.g. `sdk-core-linux`).

### The Fuchsia Core Bazel SDK

The GN `//sdk:final_fuchsia_sdk` target is used to build and
validate the official Fuchsia Bazel SDK distributed to third-party
developers. It augments the Core IDK with our set of Bazel-specific
build rules and target declarations.

Its content is directly usable by third-party Bazel projects, which
can include it with a simple `local_repository()` directive in their
`WORKSPACE.bazel` file, such as:

```
local_repository(
    name = "fuchsia_sdk",
    path = "/path/to/final_fuchsia_sdk",
)
```

Just like the Fuchsia Core IDK, the Fuchsia Core Bazel SDK is
built directly from GN, without using any Bazel workspace, and
building it is so long that this is only done on a few dedicated
builder configurations (e.g. `sdk-bazel-linux`).

### The In-Tree IDK

The GN `//sdk:bazel_in_tree_idk` target is used to build an IDK
that has the same set of atoms as the core IDK, but which only
provides prebuilt binaries for the current `target_cpu` architecture,
and the `HEAD` API level. It is only intended to be used to
populate the `@fuchsia_sdk` and `@fuchsia_in_tree_idk`
repositories (described below).

### The In-Tree Internal IDK

The GN `//sdk:bazel_internal_only_idk` target groups atoms with
and unstable API and that are not ready to be moved to the "partner"
category. This should only be used to populate the `@internal_sdk`
repository of the in-tree Bazel workspace. These atoms should
never be used outside of the platform build.

It only contains prebuilt binaries for the current `target_cpu`
architecture, and the HEAD API level.

Nothing in the GN graph should depend on this.

## The Bazel external repositories

The platform build's internal Bazel workspace also uses a number
of external repositories that are related to the IDK and the Bazel SDK:

### The `@fuchsia_in_tree_idk` repository:

This repository currently wraps the Ninja-generated in-tree IDK
as a Bazel repository. A key difference though is that its
metadata files contain Bazel target labels, instead of file
paths, for any buildable artifacts (i.e. not source files),
for example, `pkg/fdio/meta.json` looks like:

```
{
  "binaries": {
    "x64": {
      "debug": "@fuchsia_in_tree_idk//.build-id:15/646fc64e58e6bc964d5781afec10233689ab08.debug",
      "dist": "@fuchsia_in_tree_idk//arch/x64:dist/libfdio.so",
      "dist_path": "lib/libfdio.so",                             # <-- configuration string
      "link": "@fuchsia_in_tree_idk//arch/x64:lib/libfdio.so"   # <-- ninja artifact
    }
  },
  "deps": [],
  "format": "shared",
  "headers": [
    "pkg/fdio/include/lib/fdio/directory.h",   # <-- symlink to source file
    "pkg/fdio/include/lib/fdio/fd.h",          # <-- symlink to source file
    ...
  ],
  "ifs": "fdio.ifs",
  "include_dir": "pkg/fdio/include",
  "name": "fdio",
  "root": "pkg/fdio",
  "type": "cc_prebuilt_library"
}
```

In the current implementation, the labels point to simple
symlinks that go into the Ninja build directory. But this
extra level of indirection will allow, in the future, building
said artifacts directly with Bazel.

Note that this does *not* comply with the official IDK layout,
so its content cannot be used or distributed outside of the platform
build's Bazel workspace.

### The `@fuchsia_sdk` repository:

This repository exposes the same set of atoms and binaries as
the in-tree IDK, augmented with Bazel SDK rule definitions and
Bazel targets for each atom.

It is used by the `BUILD.bazel` files inside of `fuchsia.git`, to
use SDK atom targets and our set of Bazel rules to develop Fuchsia
packages with them.

It is populated by parsing the content of the `@fuchsia_in_tree_idk`
repository.

Note that its content cannot be used directly in external Bazel
workspaces.

### The `@fuchsia_internal_only_idk` repository:

This is similar to `@fuchsia_in_tree_idk`, but wraps the content of
the `//sdk:bazel_internal_only_idk` instead.

### The `@internal_sdk` repository:

This repository exposes SDK atoms and binaries from the in-tree
internal IDK to the platform build's Bazel workspace. This means
that only prebuilts for the current `target_cpu` architecture and
 `HEAD` API  levels are available there.

It is populated by parsing the content of the
`@fuchsia_internal_only_idk` repository.

### The final Fuchsia in-tree SDK

Calling `fx build generate_fuchsia_sdk_repository` will create a symlink
in `$(fx get-build-dir)/gen/build/bazel/fuchsia_sdk` pointing to a directory
whose content can be used directly in any _external_ Bazel repository.

This is useful for at least two use cases:

- Running the Bazel SDK test suite, which has its own workspace under
  `//build/bazel_sdk/tests`, which is critical to verify that all the
  rules and target declarations provided work as expected.

- Possibly developing drivers or other Fuchsia software in `fuchsia.git`
  using the developer workflows provided by the Bazel SDK rules, which
  differ considerably from what `fx` can support, while still being
  able to access internal atoms at the HEAD API level, something that
  is not possible using the Core Bazel SDK.

In both cases, this means setting up a separate Bazel workspace, and
using a directive such as:

  ```
  local_repository(
      name = "fuchsia_sdk",
      path = "/path/to/generated/fuchsia_sdk",
  )
  ```

Or using a `--repository_override=fuchsia_sdk=/path/to/generated/fuchsia_sdk`
option when invoking Bazel.

The GN target actually builds the `//build/bazel/bazel_sdk:final_fuchsia_in_tree_sdk`
target, then sets up the symlink in the Ninja output directory to point to its
content directly.

### The final Fuchsia in-tree IDK

The bazel `@fuchsia_in_tree_idk//:final_idk` target builds a directory
that contains an IDK export directory with the same atoms and binaries
as `@fuchsia_in_tree_idk`, but following the official IDK layout.

In other words, this undoes the work performed by `fuchsia_idk_repository`
by removing all Bazel target labels from metadata files. Fortunately, doing
so it pretty simple.

This is used as input for the target building the final Fuchsia
in-tree SDK.

Note that at the moment, its content should be identical to the
Ninja-generated in-tree IDK, but this will change in the future:
IDK atom definitions will be gradually moved from the GN graph to the
Bazel one. At the end of this migration, the `fuchsia_idk_repository()` rule
will disappear entirely. However, the in-tree IDK will still be needed to
generate the final in-tree SDK.

# Existing dependencies

The following diagram illustrates the dependencies between the items
described above. The notation `[foo()]` denotes a repository rule
invocation, which occurs when Bazel sets up external repositories,
while `[[bar()]]` denotes a regular build rule invoked through an
explcitit `bazel build` command.

```
GN Build Graph                                       |  Bazel Workspace
                                                     |
                                                     |
  Core IDK                                           |
     |   //sdk:final_fuchsia_idk                     |
     |                                               |
  [fuchsia_sdk_repository() in Python]               |
     |                                               |
     v                                               |
  Core Bazel SDK                                     |
        //sdk:final_fuchsia_sdk                      |
                                                     |
                                                     |
  Bazel In-Tree IDK                                  |
    //sdk:bazel_in_tree_idk                          |
                    |                                |
                    `----------[fuchsia_idk_repository()]-----> @fuchsia_in_tree_idk ---[fuchsia_sdk_repository()]---> @fuchsia_sdk
                                                     |                   |
                                                     |                   |
                                                     |            [[final_idk()]]
                                                     |                   |
                                                     |                   v
                                                     |    @fuchsia_in_tree_idk//:final_idk
                                                     |                   |
                                                     |                   |
                                                     |      [[fuchsia_sdk_repository()]]
  //build/bazel:generate_fuchsia_sdk_repository      |                   |
          |                                          |                   v
          `------------------symlink---------------------> //build/bazel/bazel_sdk:final_fuchsia_in_tree_sdk
                                                     |
                                                     |
  Bazel In-Tree Internal IDK                         |
    //sdk:bazel_internal_only_idk                    |
                    |                                |
                    `----------[fuchsia_idk_repository()]--> @fuchsia_internal_only_idk
                                                     |                   |
                                                     |                   |
                                                     |       [fuchsia_sdk_repository()]
                                                     |                   |
                                                     |                   v
                                                     |             @internal_sdk
                                                     |
```

## The `fuchsia_idk_repository()` function

This function takes an IDK as input, and populates a Bazel repository,
with it, changing the content of its metadata files to include Bazel
targets for buildable artifacts, plus adding the necessary `BUILD.bazel`
files that they reference.

Note that the output repository's content does not follow the
official IDK layout anymore, and should never be used outside of
the platform build's Bazel workspace.

## The `fuchsia_sdk_repository()` function

This function takes an IDK as input, and generates a Bazel SDK
directory or repository as output.

Its logic is written in a special way to allow it to run either in
a Starlark environment (i.e. as a Bazel repository rule), or in a
Python one (i.e. as a build action, either from Ninja or Bazel).

Currently, it is used as build time to generate the Core Bazel SDK
from the Core IDK, as a Ninja action, and the final Fuchsia in-tree
SDK, as a Bazel action.

It is also used as Starlark in the Bazel repository rules that generate
the `@fuchsia_sdk` and `@internal_sdk` repositories.

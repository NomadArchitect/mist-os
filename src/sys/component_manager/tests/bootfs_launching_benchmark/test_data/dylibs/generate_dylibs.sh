#!/bin/sh

# Copyright 2024 The Fuchsia Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

set -e

# Generates 5 synthesized dynamic libraries.
#
# Run it like:
#
# src/sys/component_manager/tests/bootfs_launching_benchmark/test_data/dylibs/generate_dylibs.sh

# Change to the script's containing directory
SCRIPT_DIR=$(cd "$(dirname "$0")" && pwd)
cd "$SCRIPT_DIR"

for N in $(seq 1 5); do
  DIR="test_library_${N}"

  # Remove existing directory if it exists
  if [ -d "$DIR" ]; then
    rm -rf "$DIR"
  fi

  mkdir "$DIR"

  # Generate BUILD.gn
  cat <<EOL > "$DIR/BUILD.gn"
# Copyright 2024 The Fuchsia Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

# Generated by $0

shared_library("test_library_${N}") {
  output_name = "test_library_${N}"
  sources = [ "lib.cc" ]
}
EOL

  # Generate lib.cc
  cat <<EOL > "$DIR/lib.cc"
// Copyright 2024 The Fuchsia Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

// Generated by $0

extern "C" {
__attribute__((visibility("default"))) int test_library_${N}_func() {
  return ${N};
}
}

EOL

  # Generate lib.h
  cat <<EOL > "$DIR/lib.h"
// Copyright 2024 The Fuchsia Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

// Generated by $0

#ifndef SRC_SYS_COMPONENT_MANAGER_TESTS_BOOTFS_LAUNCHING_BENCHMARK_TEST_DATA_DYLIBS_TEST_LIBRARY_${N}_LIB_H_
#define SRC_SYS_COMPONENT_MANAGER_TESTS_BOOTFS_LAUNCHING_BENCHMARK_TEST_DATA_DYLIBS_TEST_LIBRARY_${N}_LIB_H_

extern "C" {
__attribute__((visibility("default"))) int test_library_${N}_func();
}

#endif  // SRC_SYS_COMPONENT_MANAGER_TESTS_BOOTFS_LAUNCHING_BENCHMARK_TEST_DATA_DYLIBS_TEST_LIBRARY_${N}_LIB_H_
EOL

  fx format-code --files="$DIR/BUILD.gn,$DIR/lib.cc,$DIR/lib.h"
done
